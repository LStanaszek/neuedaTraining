<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestEd Browse</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
                #suggestionsList .dropdown-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        #suggestionsList .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        #suggestionsList .dropdown-item strong {
            color: #007bff;
        }

        #suggestionsList .dropdown-item span {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .badge-growth-positive {
            background-color: #d4edda; /* Light green */
            color: #155724; /* Dark green text */
            border-color: #c3e6cb; /* Darker green border */
        }
        .badge-growth-negative {
            background-color: #f8d7da; /* Light red */
            color: #721c24; /* Dark red text */
            border-color: #f5c6cb; /* Darker red border */
        }
    </style>
</head>
<body>
    <div id="navbar"></div>
    <h1></h1>
    <div id="modal-container"></div> <!-- Placeholder for the modal -->

    <script>
        // Fetch the navigation bar
        fetch('./navBar.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('navbar').innerHTML = data;

                // Highlight the active link
                const currentPath = window.location.pathname.split('/').pop();
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    if (link.getAttribute('href') === currentPath) {
                        link.classList.add('active');
                        link.setAttribute('aria-current', 'page');
                    } else {
                        link.classList.remove('active');
                        link.removeAttribute('aria-current');
                    }
                });
            });
                  // Load the modal from modal.html
        // Load the modal from modal.html into the modal-container div
        fetch('./modal.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('modal-container').innerHTML = data;
            })
            .catch(error => {
                console.error('Error loading modal:', error);
            });



        // Hard-coded fallback data
        const fallbackData = {
            "top_gainers": [
                {"name": "Nuvo", "ticker": "NUVOW", "current_price": "0.0193", "growth_today": "232.76%"},
                {"name": "Hyzn", "ticker": "HYZNW", "current_price": "0.0259", "growth_today": "139.81%"},
                {"name": "Mera", "ticker": "MRM", "current_price": "5.85", "growth_today": "135.89%"},
                {"name": "Ncplw", "ticker": "NCPLW", "current_price": "0.024", "growth_today": "114.29%"}
            ],
            "top_losers": [
                {"name": "Vsac", "ticker": "VSACW", "current_price": "0.0155", "growth_today": "-63.10%"},
                {"name": "Zeow", "ticker": "ZEOWW", "current_price": "0.03", "growth_today": "-49.49%"},
                {"name": "Alsa", "ticker": "ALSAR", "current_price": "0.0805", "growth_today": "-47.07%"},
                {"name": "Plmiw", "ticker": "PLMIW", "current_price": "0.0352", "growth_today": "-46.83%"}
            ]
        };

        // Function to fetch and display top gainers
        function fetchAndDisplayTopGainers() {
            fetch('http://localhost:3000/Browse/top-gainers')
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    // Check if data is empty due to API call limit use previous snapshot
                    if (Array.isArray(data) && data.length === 0) {
                        populateStockList(fallbackData.top_gainers, 'topStocksItems', 'additionalTopStocksItems');
                    } else {
                        populateStockList(data || fallbackData.top_gainers, 'topStocksItems', 'additionalTopStocksItems');
                    }
                })
                .catch(error => {
                    console.error('Error fetching top gainers:', error);
                    populateStockList(fallbackData.top_gainers, 'topStocksItems', 'additionalTopStocksItems');
                });
        }

        // Function to fetch and display top losers
        function fetchAndDisplayTopLosers() {
            fetch('http://localhost:3000/Browse/top-losers')
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    // Check if data is empty due to API call limit use previous snapshot
                    if (Array.isArray(data) && data.length === 0) {
                        populateStockList(fallbackData.top_losers, 'worstStocksItems', 'additionalWorstStocksItems');
                    } else {
                        populateStockList(data || fallbackData.top_losers, 'worstStocksItems', 'additionalWorstStocksItems');
                    }
                })
                .catch(error => {
                    console.error('Error fetching top losers:', error);
                    populateStockList(fallbackData.top_losers, 'worstStocksItems', 'additionalWorstStocksItems');
                });
        }

        // Function to populate stock lists with styling based on growth
       // Function to populate stock lists with styling based on growth
       function populateStockList(stockList, mainListId, additionalListId) {
            const mainList = document.getElementById(mainListId);
            const additionalList = document.getElementById(additionalListId);

            stockList.forEach((item, index) => {
                const name = item.name || "Unknown";
                const ticker = item.ticker || "Unknown Ticker";
                const currentPrice = item.current_price !== undefined ? `$${item.current_price}` : "N/A";
                const growthToday = item.growth_today !== undefined ? `${item.growth_today}` : "N/A";

                // Determine class for growth
                const growthValue = parseFloat(item.growth_today) || 0;
                let growthClass = '';
                if (growthValue > 0) {
                    growthClass = 'badge-growth-positive'; // Green background for positive growth
                } else if (growthValue < 0) {
                    growthClass = 'badge-growth-negative'; // Red background for negative growth
                }

                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';

                listItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span>${name} (${ticker})</span>
                            <span class="badge bg-primary badge-pill ms-2">${currentPrice}</span>
                            <span class="badge ${growthClass} ms-2">${growthToday}</span>
                        </div>
                    </div>
                `;

                if (index < 3) {
                    mainList.appendChild(listItem);
                } else {
                    additionalList.appendChild(listItem);
                }
            });
        }


        async function fetchSearchSuggestions() {
                const query = document.getElementById('searchBox').value;
            
                if (query.length < 2) {
                    document.getElementById('suggestionsList').style.display = 'none';
                    return;
                }
            
                try {
                    const response = await fetch(`http://localhost:3000/SearchSuggestion/SymbolSearch?ticker=${encodeURIComponent(query)}`);
                    const data = await response.json();
            
                    const suggestions = data.SymbolSearch;
                    const suggestionsList = document.getElementById('suggestionsList');
            
                    suggestionsList.innerHTML = ''; // Clear previous suggestions
            
                    if (suggestions.length > 0) {
                        suggestions.forEach(suggestion => {
                            const li = document.createElement('li');
                            li.classList.add('dropdown-item');
                            li.innerHTML = `<strong>${suggestion.symbol}</strong> - ${suggestion.name} (${suggestion.region})`;
                            li.onclick = () => {
                                document.getElementById('searchBox').value = suggestion.symbol;
                                document.getElementById('suggestionsList').style.display = 'none';
                            };
                            suggestionsList.appendChild(li);
                        });
                        suggestionsList.style.display = 'block';
                    } else {
                        suggestionsList.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error fetching search suggestions:', error);
                    document.getElementById('suggestionsList').style.display = 'none';
                }
            }

         // Function to fetch and display the watchlist
         async function fetchWatchlist() {
            try {
                const response = await fetch('http://localhost:3000/Browse/watchlist');
                const data = await response.json();
                const watchlistItems = document.getElementById('watchlistItems');
                const additionalWatchlistItems = document.getElementById('additionalWatchlistItems');

                data.forEach((item, index) => {
                    const name = item.name || "Unknown";
                    const ticker = item.ticker || "Unknown Ticker";
                    const currentPrice = item.current_price !== undefined ? `$${item.current_price}` : "N/A";
                    const growthToday = item.growth_today !== undefined ? `${item.growth_today}%` : "N/A"; // Added % sign

                    // Determine class for growth
                    const growthValue = parseFloat(item.growth_today) || 0;
                    let growthClass = '';
                    if (growthValue > 0) {
                        growthClass = 'badge-growth-positive'; // Green background for positive growth
                    } else if (growthValue < 0) {
                        growthClass = 'badge-growth-negative'; // Red background for negative growth
                    }

                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item';

                    listItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span>${name} (${ticker})</span>
                                <span class="badge bg-primary badge-pill ms-2">${currentPrice}</span>
                                <span class="badge ${growthClass} ms-2">${growthToday}</span>
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-primary me-2" type="button" onclick="showStockDetail('${ticker}')">View Detail</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeFromWatchlist(${item.id}, this)">Remove</button>
                            </div>
                        </div>
                    `;

                    if (index < 3) {
                        watchlistItems.appendChild(listItem);
                    } else {
                        additionalWatchlistItems.appendChild(listItem);
                    }
                });
            } catch (error) {
                console.error('Error fetching watchlist:', error);
            }
        }

        // Function to show stock details in the modal
        async function showStockDetail(ticker) {
            const modalDetailContent = document.getElementById('modalDetailContent');
            const modalTitle = document.getElementById('stockDetailModalLabel');

            try {
                const profileResponse = await fetch(`http://localhost:3000/Stockinfo/Companyinfo?ticker=${ticker}`);
                if (!profileResponse.ok) {
                    throw new Error(`Failed to fetch company profile for ${ticker}`);
                }
                const profileData = await profileResponse.json();
                const profile = profileData.CompanyInfo;

                const watchlistResponse = await fetch('http://localhost:3000/Browse/watchlist');
                const watchlistData = await watchlistResponse.json();
                const stockData = watchlistData.find(stock => stock.ticker === ticker);

                
                 // Update modal title with company logo, name, ticker, and Buy/Sell buttons
                    modalTitle.innerHTML = `
                     <img src="${profile.logo}" alt="${profile.name} logo" style="width: 30px; height: 30px; margin-right: 10px;">
                     ${profile.name} (${profile.ticker})
                    <div class="ms-auto">
                        <button class="btn btn-success btn-sm me-2" id="buyButton">Buy</button>
                        <button class="btn btn-danger btn-sm" id="sellButton">Sell</button>
                    </div>
                `;


                modalDetailContent.innerHTML = `
                    <p><strong>Current Price:</strong> $${stockData.current_price}</p>
                    <p><strong>Growth Today:</strong> ${stockData.growth_today}%</p>
                    <hr>
                    <p><strong>Country:</strong> ${profile.country}</p>
                    <p><strong>Exchange:</strong> ${profile.exchange}</p>
                    <p><strong>Phone:</strong> ${profile.phone}</p>
                    <p><strong>Website:</strong> <a href="${profile.weburl}" target="_blank">${profile.weburl}</a></p>
                `;

                const stockDetailModal = new bootstrap.Modal(document.getElementById('stockDetailModal'));
                stockDetailModal.show();

                // Add event listeners for Buy and Sell buttons
        document.getElementById('buyButton').addEventListener('click', function() {
            showBuyModal(profile, stockData);
        });

        document.getElementById('sellButton').addEventListener('click', function() {
            showSellModal(profile, stockData);
        });


            } catch (error) {
                modalDetailContent.innerHTML = `<p>Error loading company details. Please try again later.</p>`;
            }
        }

        //show stock detail from search
        function showStockDetailFromSearch() {
    const ticker = document.getElementById('searchBox').value.trim();
    
    if (ticker) {
        showStockDetail(ticker);
    } else {
        console.error('Search box is empty');
    }
    return false; // Prevent form submission
}





        // Function to remove a stock from the watchlist
        async function removeFromWatchlist(watchID, buttonElement) {
            try {
                const response = await fetch(`http://localhost:3000/Browse/watchlist/delete?watchID=${watchID}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    const listItem = buttonElement.closest('.list-group-item');
                    listItem.remove();
                } else {
                    console.error('Failed to remove stock from watchlist');
                }
            } catch (error) {
                console.error('Error removing stock from watchlist:', error);
            }
        }

        // Fetch and display data on page load
        fetchAndDisplayTopGainers();
        fetchAndDisplayTopLosers();
        fetchWatchlist();
        fetchSearchSuggestions();
        showStockDetailFromSearch()
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Watchlist Section -->
    <div class="container mt-4 d-flex justify-content-center">
        <div class="col-lg-6 col-md-8 col-sm-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>Watchlist</h4>
                    <div>
                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#watchlistCollapse" aria-expanded="false" aria-controls="watchlistCollapse">
                            View All
                        </button>
                    </div>
                </div>
                <ul class="list-group list-group-flush" id="watchlistItems">
                    <!-- Watchlist items will be populated here dynamically -->
                </ul>
                <div id="watchlistCollapse" class="collapse">
                    <ul class="list-group list-group-flush" id="additionalWatchlistItems">
                        <!-- Additional watchlist items will be populated here dynamically -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Gainers and Losers Section -->
    <div class="container mt-4 d-flex justify-content-center">
        <div class="col-lg-6 col-md-8 col-sm-12">
            <!-- Top Gainers Section -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>Top Gainers</h4>
                    <div>
                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#topGainersCollapse" aria-expanded="false" aria-controls="topGainersCollapse">
                            View All
                        </button>
                    </div>
                </div>
                <ul class="list-group list-group-flush" id="topStocksItems">
                    <!-- Top gainers will be populated here dynamically -->
                </ul>
                <div id="topGainersCollapse" class="collapse">
                    <ul class="list-group list-group-flush" id="additionalTopStocksItems">
                        <!-- Additional top gainers will be populated here dynamically -->
                    </ul>
                </div>
            </div>

            <!-- Top Losers Section -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>Top Losers</h4>
                    <div>
                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#topLosersCollapse" aria-expanded="false" aria-controls="topLosersCollapse">
                            View All
                        </button>
                    </div>
                </div>
                <ul class="list-group list-group-flush" id="worstStocksItems">
                    <!-- Top losers will be populated here dynamically -->
                </ul>
                <div id="topLosersCollapse" class="collapse">
                    <ul class="list-group list-group-flush" id="additionalWorstStocksItems">
                        <!-- Additional top losers will be populated here dynamically -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestEd Browse</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        /* Ensure that the search box and dropdown menu are in the same container */
 .search-container {
            position: relative;
            width: 100%;
        }

        #suggestionsList {
    width: 100%;
    position: relative;
    margin-top: 50px; /* Adds space below the search box */
    z-index: 1000;
    display: none; /* Initially hidden */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Optional: adds a shadow for better visibility */
}

        /* Ensure dropdown items fill the width of the dropdown menu */
        #suggestionsList .dropdown-item {
            width: 100%;
            box-sizing: border-box;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;

                        /* Prevent text from overflowing */
                        overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
                #suggestionsList .dropdown-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        #suggestionsList .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        #suggestionsList .dropdown-item strong {
            color: #0D6EFD;
        }

        #suggestionsList .dropdown-item span {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .badge-growth-positive {
            background-color: #d4edda; /* Light green */
            color: #155724; /* Dark green text */
            border-color: #c3e6cb; /* Darker green border */
        }
        .badge-growth-negative {
            background-color: #f8d7da; /* Light red */
            color: #721c24; /* Dark red text */
            border-color: #f5c6cb; /* Darker red border */
        }
    </style>
</head>
<body>
    <div id="navbar"></div>
    <div id="addFundsContainer"></div>
    <div id="drawFundsContainer"></div>
    <div id="modal-container"></div> <!-- Placeholder for the modal -->

    <script>
        // Fetch the navigation bar
        fetch('./navBar.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('navbar').innerHTML = data;

                // Highlight the active link
                const currentPath = window.location.pathname.split('/').pop();
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    if (link.getAttribute('href') === currentPath) {
                        link.classList.add('active');
                        link.setAttribute('aria-current', 'page');
                    } else {
                        link.classList.remove('active');
                        link.removeAttribute('aria-current');
                    }
                });
            });
                  // Load the modal from modal.html
        // Load the modal from modal.html into the modal-container div
        fetch('./modal.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('modal-container').innerHTML = data;
            })
            .catch(error => {
                console.error('Error loading modal:', error);
            });

            fetch('./modal2.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('modal-container').innerHTML = data;
            })
            .catch(error => {
                console.error('Error loading modal:', error);
            });



        // Hard-coded fallback data
        const fallbackData = {
            "top_gainers": [
                {"name": "Nuvo", "ticker": "NUVOW", "current_price": "0.0193", "growth_today": "232.76%"},
                {"name": "Hyzn", "ticker": "HYZNW", "current_price": "0.0259", "growth_today": "139.81%"},
                {"name": "Mera", "ticker": "MRM", "current_price": "5.85", "growth_today": "135.89%"},
                {"name": "Ncplw", "ticker": "NCPLW", "current_price": "0.024", "growth_today": "114.29%"}
            ],
            "top_losers": [
                {"name": "Vsac", "ticker": "VSACW", "current_price": "0.0155", "growth_today": "-63.10%"},
                {"name": "Zeow", "ticker": "ZEOWW", "current_price": "0.03", "growth_today": "-49.49%"},
                {"name": "Alsa", "ticker": "ALSAR", "current_price": "0.0805", "growth_today": "-47.07%"},
                {"name": "Plmiw", "ticker": "PLMIW", "current_price": "0.0352", "growth_today": "-46.83%"}
            ]
        };

        /*
        // Function to fetch and display top gainers
// Function to fetch and display top gainers
function fetchAndDisplayTopGainers() {
    fetch('./Browse/top-gainers')
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if (Array.isArray(data) && data.length === 0) {
                populateStockListFallback(fallbackData.top_gainers, 'topStocksItems', 'additionalTopStocksItems');
            } else {
                populateStockListBackend(data || fallbackData.top_gainers, 'topStocksItems', 'additionalTopStocksItems');
            }
        })
        .catch(error => {
            console.error('Error fetching top gainers:', error);
            populateStockListFallback(fallbackData.top_gainers, 'topStocksItems', 'additionalTopStocksItems');
        });
}
*/
// Function to fetch and display top losers
/*
function fetchAndDisplayTopLosers() {
    fetch('./Browse/top-losers')
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if (Array.isArray(data) && data.length === 0) {
                populateStockListFallback(fallbackData.top_losers, 'worstStocksItems', 'additionalWorstStocksItems');
            } else {
                populateStockListBackend(data || fallbackData.top_losers, 'worstStocksItems', 'additionalWorstStocksItems');
            }
        })
        .catch(error => {
            console.error('Error fetching top losers:', error);
            populateStockListFallback(fallbackData.top_losers, 'worstStocksItems', 'additionalWorstStocksItems');
        });
}
*/
        

// Function to populate stock lists with styling based on growth
function populateStockListBackend(stockList, mainListId, additionalListId) {
    const mainList = document.getElementById(mainListId);
    const additionalList = document.getElementById(additionalListId);

    stockList.forEach((item, index) => {
        let name = item.name || "Unknown";
        const ticker = item.ticker || "Unknown Ticker";
        const currentPrice = item.price !== undefined ? `$${item.price}` : "N/A";
        
        // Format the growth percentage to two decimal places
        const growthToday = item.change_percentage !== undefined ? `${parseFloat(item.change_percentage).toFixed(2)}%` : "N/A";

        // If the name is "Unknown Stock", use the ticker instead and capitalize it
        if (name === "Unknown Stock") {
            name = ticker.charAt(0).toUpperCase() + ticker.slice(1).toLowerCase();
        }

        // Determine class for growth
        const growthValue = parseFloat(item.change_amount) || 0;
        let growthClass = '';
        if (growthValue > 0) {
            growthClass = 'badge-growth-positive'; // Green background for positive growth
        } else if (growthValue < 0) {
            growthClass = 'badge-growth-negative'; // Red background for negative growth
        }

        const listItem = document.createElement('li');
        listItem.className = 'list-group-item';

        listItem.innerHTML = `
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <span>${name} (${ticker})</span>
        </div>
        <div>
            <span class="badge bg-primary badge-pill ms-2">${currentPrice}</span>
            <span class="badge ${growthClass} ms-2">${growthToday}</span>
        </div>
    </div>
`;

        if (index < 3) {
            mainList.appendChild(listItem);
        } else {
            additionalList.appendChild(listItem);
        }
    });
}

function populateStockListFallback(stockList, mainListId, additionalListId) {
    const mainList = document.getElementById(mainListId);
    const additionalList = document.getElementById(additionalListId);

    stockList.forEach((item, index) => {
        let name = item.name || "Unknown";
        const ticker = item.ticker || "Unknown Ticker";
        const currentPrice = item.current_price !== undefined ? `$${item.current_price}` : "N/A";
        
        // Format the growth percentage to two decimal places
        const growthToday = item.growth_today !== undefined ? `${parseFloat(item.growth_today).toFixed(2)}` : "N/A";

        // If the name is "Unknown Stock", use the ticker instead and capitalize it
        if (name === "Unknown Stock") {
            name = ticker.charAt(0).toUpperCase() + ticker.slice(1).toLowerCase();
        }

        // Determine class for growth
        const growthValue = parseFloat(item.growth_today) || 0;
        let growthClass = '';
        if (growthValue > 0) {
            growthClass = 'badge-growth-positive'; // Green background for positive growth
        } else if (growthValue < 0) {
            growthClass = 'badge-growth-negative'; // Red background for negative growth
        }

        const listItem = document.createElement('li');
        listItem.className = 'list-group-item';

listItem.innerHTML = `
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <span>${name} (${ticker})</span>
        </div>
        <div>
            <span class="badge bg-primary badge-pill ms-2">${currentPrice}</span>
            <span class="badge ${growthClass} ms-2">${growthToday}</span>
        </div>
    </div>
`;

        if (index < 3) {
            mainList.appendChild(listItem);
        } else {
            additionalList.appendChild(listItem);
        }
    });
}




async function fetchSearchSuggestions() {
    const query = document.getElementById('searchBox').value;

    if (query.length < 2) {
        document.getElementById('suggestionsList').style.display = 'none';
        return;
    }

    try {
        const response = await fetch(`./SearchSuggestion/api/autocomplete?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        const suggestions = data;
        const suggestionsList = document.getElementById('suggestionsList');

        suggestionsList.innerHTML = ''; // Clear previous suggestions

        if (suggestions.length > 0) {
            // Filter out suggestions with undefined or invalid symbols and names
            const validSuggestions = suggestions.filter(suggestion => 
                suggestion.symbol && suggestion.symbol.trim() !== '' &&
                suggestion.name && suggestion.name.trim() !== ''
            );

            if (validSuggestions.length > 0) {
                validSuggestions.forEach(suggestion => {
                    const li = document.createElement('li');
                    li.classList.add('dropdown-item');
                    li.innerHTML = `<strong>${suggestion.symbol}</strong> - ${suggestion.name}`;
                    li.onclick = () => {
                        document.getElementById('searchBox').value = suggestion.symbol;
                        document.getElementById('suggestionsList').style.display = 'none';
                    };
                    suggestionsList.appendChild(li);
                });
                suggestionsList.style.display = 'block';
            } else {
                suggestionsList.style.display = 'none';
            }
        } else {
            suggestionsList.style.display = 'none';
        }
    } catch (error) {
        console.error('Error fetching search suggestions:', error);
        document.getElementById('suggestionsList').style.display = 'none';
    }
}







         // Function to fetch and display the watchlist
       // Function to fetch and display the watchlist
       async function fetchWatchlist() {
            try {
                const response = await fetch('./Browse/watchlist');
                const data = await response.json();
                const watchlistItems = document.getElementById('watchlistItems');
                const additionalWatchlistItems = document.getElementById('additionalWatchlistItems');

                data.forEach((item, index) => {
                    const name = item.name || "Unknown";
                    const ticker = item.ticker || "Unknown Ticker";
                    const currentPrice = item.current_price !== undefined ? `$${item.current_price}` : "N/A";
                    const growthToday = item.growth_today !== undefined ? `${item.growth_today}%` : "N/A"; // Added % sign

                    // Determine class for growth
                    const growthValue = parseFloat(item.growth_today) || 0;
                    let growthClass = '';
                    if (growthValue > 0) {
                        growthClass = 'badge-growth-positive'; // Green background for positive growth
                    } else if (growthValue < 0) {
                        growthClass = 'badge-growth-negative'; // Red background for negative growth
                    }

                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item';

listItem.innerHTML = `
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <span>${name} (${ticker})</span>
        </div>
        <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-outline-primary me-2" type="button" onclick="showStockDetail('${ticker}')">View Detail</button>
            <button class="btn btn-sm btn-outline-danger me-2" onclick="removeFromWatchlist(${item.id}, this)">Remove</button>
            <span class="badge bg-primary badge-pill ms-2">${currentPrice}</span>
            <span class="badge ${growthClass} ms-2">${growthToday}</span>
        </div>
    </div>
`;


                    if (index < 3) {
                        watchlistItems.appendChild(listItem);
                    } else {
                        additionalWatchlistItems.appendChild(listItem);
                    }
                });
            } catch (error) {
                console.error('Error fetching watchlist:', error);
            }
        }
        // Function to show stock details in the modal
// Function to show stock details in the modal
// Function to show stock details in the modal
// Function to show stock details in the modal
async function showStockDetail(ticker) {
    const modalDetailContent = document.getElementById('modalDetailContent');
    const modalTitle = document.getElementById('stockDetailModalLabel');

    try {
        // Fetch company profile
        const profileResponse = await fetch(`./Stockinfo/Companyinfo?ticker=${ticker}`);
        if (!profileResponse.ok) {
            throw new Error(`Failed to fetch company profile for ${ticker}`);
        }
        const profileData = await profileResponse.json();
        const profile = profileData.CompanyInfo;

        // Fetch watchlist data
        const watchlistResponse = await fetch('./Browse/watchlist');
        const watchlistData = await watchlistResponse.json();
        const stockData = watchlistData.find(stock => stock.ticker === ticker);

        // Fetch user balance
        const balanceResponse = await fetch('./Dashboard/Balance?userId=1');
        const balanceData = await balanceResponse.json();

        // Fetch user's current share amount
        const shareAmountResponse = await fetch(`./Checkout/GetShareAmount?userId=1&ticker=${ticker}`);
        const shareAmountData = await shareAmountResponse.json();

        console.log(shareAmountData.netShares);

        // Update modal title with company logo, name, ticker, and Buy/Sell buttons
        modalTitle.innerHTML = `
            <img src="${profile.logo}" alt="${profile.name} logo" style="width: 30px; height: 30px; margin-right: 10px;">
            ${profile.name} (${profile.ticker})
            <div class="ms-auto">
                <button class="btn btn-success btn-sm me-2" id="buyButton">Buy</button>
                <button class="btn btn-danger btn-sm" id="sellButton">Sell</button>
            </div>
        `;

        // Update modal content with current price, growth, balance, and shares owned
        modalDetailContent.innerHTML = `
            <p><strong>Current Price:</strong> $${stockData.current_price}</p>
            <p><strong>Growth Today:</strong> ${stockData.growth_today}%</p>
            <hr>
            <p><strong>Your Balance:</strong> $${balanceData.balance}</p>
            <p><strong>Your Shares:</strong> ${shareAmountData.netShares} shares</p>
            <p><strong>Country:</strong> ${profile.country}</p>
            <p><strong>Exchange:</strong> ${profile.exchange}</p>
            <p><strong>Phone:</strong> ${profile.phone}</p>
            <p><strong>Website:</strong> <a href="${profile.weburl}" target="_blank">${profile.weburl}</a></p>
        `;

        // Show the modal
        const stockDetailModal = new bootstrap.Modal(document.getElementById('stockDetailModal'));
        stockDetailModal.show();

        // Remove previous event listeners before adding new ones
        document.getElementById('buyButton').replaceWith(document.getElementById('buyButton').cloneNode(true));
        document.getElementById('sellButton').replaceWith(document.getElementById('sellButton').cloneNode(true));

        // Add event listeners for Buy and Sell buttons
        document.getElementById('buyButton').addEventListener('click', function() {
            stockDetailModal.hide(); // Hide the View Detail modal
            showBuyModal(profile, stockData.current_price, balanceData.balance);
        });

        document.getElementById('sellButton').addEventListener('click', function() {
            stockDetailModal.hide(); // Hide the View Detail modal
            showSellModal(profile, stockData.current_price, shareAmountData.ticker);
        });

    } catch (error) {
        modalDetailContent.innerHTML = `<p>Error loading company details. Please try again later.</p>`;
    }
}


// Show Buy Modal
function showBuyModal(profile, current_price, userBalance) {
    const buyStockModal = new bootstrap.Modal(document.getElementById('buyStockModal'));

    // Populate the Buy modal with company details
    document.getElementById('buyCompanyName').textContent = profile.name;
    document.getElementById('buyTicker').textContent = profile.ticker;
    document.getElementById('buyPrice').textContent = current_price;
    document.getElementById('userBalance').textContent = userBalance;

     // Remove previous event listener before adding a new one
     document.getElementById('confirmBuyButton').replaceWith(document.getElementById('confirmBuyButton').cloneNode(true));

    document.getElementById('confirmBuyButton').addEventListener('click', async function() {
        const shareQuantity = parseInt(document.getElementById('buyQuantity').value, 10);
        if (isNaN(shareQuantity) || shareQuantity <= 0) {
            alert('Please enter a valid number of shares.');
            return;
        }

        try {
            const response = await fetch('./Checkout/BuyStocks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ticker: profile.ticker,
                    share_quantity: shareQuantity,
                    user_id: 1, // Default user ID
                }),
            });

            if (!response.ok) {
                throw new Error('Failed to purchase stocks.');
            }

            const data = await response.json();
            buyStockModal.hide();
            alert('Your purchase is successful!');
        } catch (error) {
            alert('Error purchasing stocks: ' + error.message);
        }
    });

    buyStockModal.show();
}

// Show Sell Modal
function showSellModal(profile, current_price, userShares) {
    const sellStockModal = new bootstrap.Modal(document.getElementById('sellStockModal'));

    // Populate the Sell modal with company details
    document.getElementById('sellCompanyName').textContent = profile.name;
    document.getElementById('sellTicker').textContent = profile.ticker;
    document.getElementById('sellPrice').textContent = current_price;
    document.getElementById('userShares').textContent = userShares;

       // Remove previous event listener before adding a new one
       document.getElementById('confirmSellButton').replaceWith(document.getElementById('confirmSellButton').cloneNode(true));

    document.getElementById('confirmSellButton').addEventListener('click', async function() {
        const shareQuantity = parseInt(document.getElementById('sellQuantity').value, 10);
        if (isNaN(shareQuantity) || shareQuantity <= 0) {
            alert('Please enter a valid number of shares.');
            return;
        }

        try {
            const response = await fetch('./Checkout/SellStocks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ticker: profile.ticker,
                    share_quantity: shareQuantity,
                    user_id: 1, // Default user ID
                }),
            });

            if (!response.ok) {
                throw new Error('Failed to sell stocks.');
            }

            const data = await response.json();
            alert(data.message);
            sellStockModal.hide();
        } catch (error) {
            alert('Error selling stocks: ' + error.message);
        }
    });

    sellStockModal.show();
}
        


async function showSearchResult(ticker) {
    const modalDetailContent = document.getElementById('modalDetailContent');
    const modalTitle = document.getElementById('stockDetailModalLabel');

    try {
        // Fetch company profile
        const profileResponse = await fetch(`http://localhost:3000/Stockinfo/Companyinfo?ticker=${ticker}`);
        if (!profileResponse.ok) {
            console.log("ERROR");
            throw new Error(`Failed to fetch company profile for ${ticker}`);
        }
        const profileData = await profileResponse.json();
        const profile = profileData.CompanyInfo;
        console.log("888888888888888");
        
        // Fetch user balance
       
        const balanceResponse = await fetch('http://localhost:3000/Dashboard/Balance?userId=1');
        const balanceData = await balanceResponse.json();
        console.log(balanceData.balance);
        // Fetch user's current share amount
        const shareAmountResponse = await fetch(`http://localhost:3000/Checkout/GetShareAmount?userId=1&ticker=${ticker}`);
        const shareAmountData = await shareAmountResponse.json();

        const priceandgrowth= await fetch(`http://localhost:3000/Stockinfo/GetPriceAndGrowth/?ticker=${ticker}`);
        const pricegrowthdata= await priceandgrowth.json();
        
        // Update modal title with company logo, name, ticker, and Buy/Sell buttons
        modalTitle.innerHTML = `
            <img src="${profile.logo}" alt="${profile.name} logo" style="width: 30px; height: 30px; margin-right: 10px;">
            ${profile.name} (${profile.ticker})
            <div class="ms-auto">
                <button class="btn btn-success btn-sm me-2" id="buyButton">Buy</button>
                <button class="btn btn-danger btn-sm" id="sellButton">Sell</button>
            </div>
        `;
        
        // Update modal content with current price, growth, balance, and shares owned
        modalDetailContent.innerHTML = `
            <p><strong>Your Balance:</strong> $${balanceData.balance}</p>
            <p><strong>Your Shares:</strong> ${shareAmountData.netShares} shares</p>
            <p><strong>Country:</strong> ${profile.country}</p>
            <p><strong>Current Price:</strong> ${pricegrowthdata.priceAndGrowth.currentPrice}</p>
            <p><strong>Growth:</strong> ${pricegrowthdata.priceAndGrowth.growth}</p>
            <p><strong>Exchange:</strong> ${profile.exchange}</p>
            <p><strong>Phone:</strong> ${profile.phone}</p>
            <p><strong>Website:</strong> <a href="${profile.weburl}" target="_blank">${profile.weburl}</a></p>
        `;
       
        //Show the modal
        const stockDetailModal = new bootstrap.Modal(document.getElementById('stockDetailModal'));
        stockDetailModal.show();
        
        // Remove previous event listeners before adding new ones
        document.getElementById('buyButton').replaceWith(document.getElementById('buyButton').cloneNode(true));
        document.getElementById('sellButton').replaceWith(document.getElementById('sellButton').cloneNode(true));

        // Add event listeners for Buy and Sell buttons
        document.getElementById('buyButton').addEventListener('click', function() {
            stockDetailModal.hide(); // Hide the View Detail modal
            showBuyModal(profile, pricegrowthdata.priceAndGrowth.currentPrice, balanceData.balance);
        });

        document.getElementById('sellButton').addEventListener('click', function() {
            stockDetailModal.hide(); // Hide the View Detail modal
            showSellModal(profile, pricegrowthdata.priceAndGrowth.currentPrice, shareAmountData.ticker);
        });

        console.log('error finush');

    } catch (error) {
        modalDetailContent.innerHTML = `<p>Error loading company details. Please try again later.</p>`;
    }
}
   
        
        
        //show stock detail from search
     function showStockDetailFromSearch() {
    const ticker = document.getElementById('searchBox').value.trim();
    if (ticker) {
        showSearchResult(ticker);
    } else {
        console.error('Search box is empty');
    }
    return false; // Prevent form submission
}



        // Function to remove a stock from the watchlist
        async function removeFromWatchlist(watchID, buttonElement) {
            try {
                const response = await fetch(`./Browse/watchlist/delete?watchID=${watchID}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    const listItem = buttonElement.closest('.list-group-item');
                    listItem.remove();
                } else {
                    console.error('Failed to remove stock from watchlist');
                }
            } catch (error) {
                console.error('Error removing stock from watchlist:', error);
            }
        }

        // Fetch and display data on page load
        fetchAndDisplayTopGainers();
        fetchAndDisplayTopLosers();
        fetchWatchlist();
        //fetchSearchSuggestions();
        
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Watchlist Section -->
    <div class="container mt-4 d-flex justify-content-center">
        <div class="col-lg-6 col-md-8 col-sm-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>Watchlist</h4>
                    <div>
                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#watchlistCollapse" aria-expanded="false" aria-controls="watchlistCollapse">
                            View All
                        </button>
                    </div>
                </div>
                <ul class="list-group list-group-flush" id="watchlistItems">
                    <!-- Watchlist items will be populated here dynamically -->
                </ul>
                <div id="watchlistCollapse" class="collapse">
                    <ul class="list-group list-group-flush" id="additionalWatchlistItems">
                        <!-- Additional watchlist items will be populated here dynamically -->
                    </ul>
                </div>
            </div>
        </div>
    </div>


<!-- Buy Stock Modal -->
<div class="modal fade" id="buyStockModal" tabindex="-1" aria-labelledby="buyStockModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="buyStockModalLabel">Buy Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Company:</strong> <span id="buyCompanyName"></span></p>
                <p><strong>Ticker:</strong> <span id="buyTicker"></span></p>
                <p><strong>Current Price:</strong> $<span id="buyPrice"></span></p>
                <p><strong>Your Balance:</strong> $<span id="userBalance"></span></p>
                <div class="mb-3">
                    <label for="buyQuantity" class="form-label">Number of Shares</label>
                    <input type="number" class="form-control" id="buyQuantity" min="1" placeholder="Enter number of shares">
                </div>
                <button type="button" class="btn btn-primary" id="confirmBuyButton">Confirm Buy</button>
            </div>
        </div>
    </div>
</div>

<!-- Sell Stock Modal -->
<div class="modal fade" id="sellStockModal" tabindex="-1" aria-labelledby="sellStockModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sellStockModalLabel">Sell Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Company:</strong> <span id="sellCompanyName"></span></p>
                <p><strong>Ticker:</strong> <span id="sellTicker"></span></p>
                <p><strong>Current Price:</strong> $<span id="sellPrice"></span></p>
                <p><strong>Your Shares:</strong> <span id="userShares"></span> shares</p>
                <div class="mb-3">
                    <label for="sellQuantity" class="form-label">Number of Shares</label>
                    <input type="number" class="form-control" id="sellQuantity" min="1" placeholder="Enter number of shares">
                </div>
                <button type="button" class="btn btn-primary" id="confirmSellButton">Confirm Sell</button>
            </div>
        </div>
    </div>
</div>



    <!-- Top Gainers and Losers Section -->
    <div class="container mt-4 d-flex justify-content-center">
        <div class="col-lg-6 col-md-8 col-sm-12">
            <!-- Top Gainers Section -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>Top Gainers</h4>
                    <div>
                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#topGainersCollapse" aria-expanded="false" aria-controls="topGainersCollapse">
                            View All
                        </button>
                    </div>
                </div>
                <ul class="list-group list-group-flush" id="topStocksItems">
                    <!-- Top gainers will be populated here dynamically -->
                </ul>
                <div id="topGainersCollapse" class="collapse">
                    <ul class="list-group list-group-flush" id="additionalTopStocksItems">
                        <!-- Additional top gainers will be populated here dynamically -->
                    </ul>
                </div>
            </div>

            <!-- Top Losers Section -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>Top Losers</h4>
                    <div>
                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#topLosersCollapse" aria-expanded="false" aria-controls="topLosersCollapse">
                            View All
                        </button>
                    </div>
                </div>
                <ul class="list-group list-group-flush" id="worstStocksItems">
                    <!-- Top losers will be populated here dynamically -->
                </ul>
                <div id="topLosersCollapse" class="collapse">
                    <ul class="list-group list-group-flush" id="additionalWorstStocksItems">
                        <!-- Additional top losers will be populated here dynamically -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- NAV BAR, ADD FUNDS, WITHDRAW FUNDS, FREE FUNDS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetch('./navBar.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('navbar').innerHTML = data;
    
                    // Highlight active button
                    let currentPath = window.location.pathname.split('/').pop();
                    if (currentPath === '') {
                        currentPath = 'index.html';
                    }
    
                    const navLinks = document.querySelectorAll('.nav-link');
                    navLinks.forEach(link => {
                        if (link.getAttribute('href') === currentPath) {
                            link.classList.add('active');
                            link.setAttribute('aria-current', 'page');
                        } else {
                            link.classList.remove('active');
                            link.removeAttribute('aria-current');
                        }
                    });
    
                    // Handle Add Funds button click
                    const addFundsButton = document.querySelector('.addFundsButton');
                    if (addFundsButton) {
                        addFundsButton.addEventListener('click', function (e) {
                            e.preventDefault();
    
                            fetch('addFunds.html')
                                .then(response => response.text())
                                .then(data => {
                                    document.getElementById('addFundsContainer').innerHTML = data;
                                    const addFundsModal = new bootstrap.Modal(document.getElementById('addFundsModal'));
                                    addFundsModal.show();
                                    
                                    // Set up form submission handling
                                    setupFundsForm("Add");
                                })
                                .catch(error => console.error('Error loading modal:', error));
                        });
                    }

                    // Handle Withdraw Funds button click
                    const drawFundsButton = document.querySelector('.drawFundsButton');
                    if (drawFundsButton) {
                        drawFundsButton.addEventListener('click', function (e) {
                            e.preventDefault();
    
                            fetch('drawFunds.html')
                                .then(response => response.text())
                                .then(data => {
                                    document.getElementById('drawFundsContainer').innerHTML = data;
                                    const drawFundsModal = new bootstrap.Modal(document.getElementById('drawFundsModal'));
                                    drawFundsModal.show();
                                    
                                    // Set up form submission handling
                                    setupFundsForm("Withdraw", "fundsDrawAmount", "cardDrawNumber", "expiryDrawDate", "drawcvv");
                                })
                                .catch(error => console.error('Error loading modal:', error));
                        });
                    }
                })
                .catch(error => console.error('Error fetching navbar:', error));
    

                function setupFundsForm(choice, amount = "fundsAmount", inputCardNumber = "cardNumber", inputExpiryDate = "expiryDate", inputCvv = "cvv") {
                    let formId, apiEndpoint, modalId, submitButtonSelector;

                    if (choice === "Add") {
                        formId = "addFundsForm";
                        apiEndpoint = "./Dashboard/AddFunds";
                        modalId = "addFundsModal";
                        submitButtonSelector = ".addFundsConfirm";
                    } else if (choice === "Withdraw") {
                        formId = "drawFundsForm";
                        apiEndpoint = "./Dashboard/WithdrawFunds";
                        modalId = "drawFundsModal";
                        submitButtonSelector = ".drawFundsConfirm";
                    }

                    // Get the form element and replace it with a clone to remove old event listeners
                    const fundsForm = document.getElementById(formId);
                    if (!fundsForm) {
                        console.error(`${choice} Funds Form not found`);
                        return;
                    }

                    const clonedFundsForm = fundsForm.cloneNode(true); // Clone the form to reset listeners
                    fundsForm.replaceWith(clonedFundsForm); // Replace the old form with the new cloned form

                    // Add a new event listener to the cloned form
                    clonedFundsForm.addEventListener('submit', function (e) {
                        e.preventDefault();

                        const fundsAmount = parseFloat(document.getElementById(amount).value); // Convert to float
                        const cardNumber = document.getElementById(inputCardNumber).value;
                        const expiryDate = document.getElementById(inputExpiryDate).value;
                        const cvv = document.getElementById(inputCvv).value;

                        if (isNaN(fundsAmount) || cardNumber === '' || expiryDate === '' || cvv === '') {
                            alert('Please fill out all fields correctly');
                            return;
                        }


                        fetch(apiEndpoint, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                user_id: 1,
                                amount: fundsAmount // Pass as a number
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            const roundedBalance = (parseFloat(data.user.balance).toFixed(2)).toLocaleString();
                            document.getElementById('freeCash').textContent = `$${parseFloat(roundedBalance).toLocaleString()}`;
                            const fundsModal = bootstrap.Modal.getInstance(document.getElementById(modalId));
                            if (fundsModal) {
                                fundsModal.hide();
                            }
                        })
                        .catch(error => {
                            alert('Insufficient funds');
                        });
                    });

                    // Add submit button functionality
                    const fundsConfirmButton = document.querySelector(submitButtonSelector);
                    if (fundsConfirmButton) {
                        fundsConfirmButton.addEventListener('click', function () {
                            clonedFundsForm.dispatchEvent(new Event('submit')); // Trigger the form submission programmatically
                        });
                    }
                }

                
                
    
            // Fetch and display the free cash balance
            fetch('./Dashboard/Balance?userId=1')
                .then(response => response.json())
                .then(data => {

                    document.getElementById('freeCash').textContent = `$${parseFloat(data.balance).toLocaleString()}`;
                })
                .catch(error => console.error('Error fetching balance data:', error));
        });
    </script>




</body>
</html>